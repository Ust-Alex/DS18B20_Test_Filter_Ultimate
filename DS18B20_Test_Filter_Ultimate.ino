/**
 * DS18B20_Test_Filter_Ultimate.ino
 * 
 * –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–´–ô –¢–ï–°–¢–ï–† –§–ò–õ–¨–¢–†–ê–¶–ò–ò –î–õ–Ø –î–ê–¢–ß–ò–ö–û–í DS18B20
 * 
 * –û–°–û–ë–ï–ù–ù–û–°–¢–ò:
 * 1. –ß–∏—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑ "—É–º–Ω—ã—Ö" —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
 * 2. –ü–æ–¥—Ä–æ–±–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —à—É–º–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω–æ–π
 * 3. –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ —à—É–º–∞
 * 4. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º —Å—Ç–æ–ª–±—Ü–æ–≤
 * 5. –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
 * 6. –¢–µ—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ —Å –æ—Ç—Å—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏
 * 
 * –í–ï–†–°–ò–Ø: 3.0
 * –î–ê–¢–ê: 2024
 * –ê–í–¢–û–†: AI Assistant
 * 
 * –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï DS18B20:
 * DATA ‚Üí GPIO4, VCC ‚Üí 3.3V, GND ‚Üí GND, —Ä–µ–∑–∏—Å—Ç–æ—Ä 4.7–∫–û–º –º–µ–∂–¥—É DATA –∏ VCC
 */

#include <OneWire.h>
#include <DallasTemperature.h>

// ============================================================================
// –†–ê–ó–î–ï–õ 1: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´
// ============================================================================

/* –†–ê–ó–†–ï–®–ï–ù–ò–ï –î–ê–¢–ß–ò–ö–ê (9-12 –±–∏—Ç)
 * 9 –±–∏—Ç:   —à–∞–≥ 0.5¬∞C,   –≤—Ä–µ–º—è 93.75 –º—Å
 * 10 –±–∏—Ç:  —à–∞–≥ 0.25¬∞C,  –≤—Ä–µ–º—è 187.5 –º—Å
 * 11 –±–∏—Ç:  —à–∞–≥ 0.125¬∞C, –≤—Ä–µ–º—è 375 –º—Å
 * 12 –±–∏—Ç:  —à–∞–≥ 0.0625¬∞C, –≤—Ä–µ–º—è 750 –º—Å
 */
#define RESOLUTION 12

/* –ò–ù–¢–ï–†–í–ê–õ –ò–ó–ú–ï–†–ï–ù–ò–ô (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
 * –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ë–û–õ–¨–®–ï –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –¥–∞—Ç—á–∏–∫–∞:
 * - –î–ª—è 12 –±–∏—Ç: –º–∏–Ω–∏–º—É–º 1000 –º—Å, –ª—É—á—à–µ 1500-2000 –º—Å
 */
#define MEASURE_INTERVAL 1500

/* –¢–ò–ü –§–ò–õ–¨–¢–†–ê
 * 0 - –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
 * 1 - –ú–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
 * 2 - –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
 * 3 - –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
 * 4 - –î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π (–º–µ–¥–∏–∞–Ω–∞ + —ç–∫—Å–ø.—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ)
 */
#define FILTER_TYPE 0

/* –†–ê–ó–ú–ï–† –§–ò–õ–¨–¢–†–ê (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –≤ –±—É—Ñ–µ—Ä–µ)
 * –ë–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä = –ª—É—á—à–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ, –Ω–æ –±–æ–ª—å—à–µ –∑–∞–ø–∞–∑–¥—ã–≤–∞–Ω–∏–µ
 * –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
 * - –ú–µ–¥–∏–∞–Ω–Ω—ã–π: 3, 5, 7, 9 (–Ω–µ—á—ë—Ç–Ω—ã–µ —á–∏—Å–ª–∞)
 * - –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ: 5, 7, 9, 11
 */
#define FILTER_SIZE 1

/* –ü–û–†–û–ì –î–ï–¢–ï–ö–¶–ò–ò –ò–ó–ú–ï–ù–ï–ù–ò–ô (¬∞C)
 * –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä–æ–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–Ω–∞—á–∏–º—ã–º
 * –í–ê–ñ–ù–û: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ —É—Ä–æ–≤–Ω—è —à—É–º–∞ –¥–∞—Ç—á–∏–∫–∞
 */
#define DELTA_THRESHOLD 0.10

/* –¢–û–ß–ù–û–°–¢–¨ –û–ö–†–£–ì–õ–ï–ù–ò–Ø (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)
 * 1 - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 0.1¬∞C
 * 2 - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 0.01¬∞C
 * 3 - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 0.001¬∞C
 */
#define ROUND_TO_DECIMALS 2

/* –†–ï–ñ–ò–ú –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
 * 0 - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç (–∏–∑–º–µ—Ä—è–µ—Ç —à—É–º, –∑–∞—Ç–µ–º —Ä–µ–∞–∫—Ü–∏—é)
 * 1 - –¢–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ —à—É–º–∞ (–¥–∞—Ç—á–∏–∫ –≤ –ø–æ–∫–æ–µ)
 * 2 - –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ (–∏–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞)
 */
#define TEST_MODE 1

/* –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –¢–ï–°–¢–ê (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π)
 * 50-100  - –±—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ (1-3 –º–∏–Ω—É—Ç—ã)
 * 150-200 - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (4-6 –º–∏–Ω—É—Ç)
 * 300+    - –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (7+ –º–∏–Ω—É—Ç)
 */
#define TEST_DURATION 120

// ============================================================================
// –†–ê–ó–î–ï–õ 2: –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø
// ============================================================================

// –®–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞ CSV (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
#define CSV_TIME_WIDTH 12   // –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ "–í–†–ï–ú–Ø_–ú–°"
#define CSV_TEMP_WIDTH 14   // –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ "–¢–ï–ú–ü_–°–´–†–ê–Ø" –∏ "–¢–ï–ú–ü_–§–ò–õ–¨–¢"
#define CSV_DELTA_WIDTH 10  // –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ "–î–ï–õ–¨–¢–ê"

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
#define HISTOGRAM_WIDTH 20  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (20 —Å–∏–º–≤–æ–ª–æ–≤)
#define HISTOGRAM_BINS 13   // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (13: -0.06 –¥–æ +0.06)

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
#define AUTOCORR_LAGS 3  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–≥–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (1, 2, 3)

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
#define PROGRESS_BAR_WIDTH 40  // –®–∏—Ä–∏–Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö

// ============================================================================
// –†–ê–ó–î–ï–õ 3: –ê–ü–ü–ê–†–ê–¢–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ============================================================================

// –ü–∏–Ω –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —à–∏–Ω—ã 1-Wire
const int ONE_WIRE_BUS = 4;

// –û–±—ä–µ–∫—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º 1-Wire –∏ –¥–∞—Ç—á–∏–∫–∞–º–∏ Dallas
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);
DeviceAddress sensorAddress;

// ============================================================================
// –†–ê–ó–î–ï–õ 4: –°–¢–†–£–ö–¢–£–†–´ –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–•
// ============================================================================

/* –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –ú–ï–î–ò–ê–ù–ù–û–ì–û –§–ò–õ–¨–¢–†–ê
 * –•—Ä–∞–Ω–∏—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä –∏ –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
 */
typedef struct {
  float buffer[15];  // –ë—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π (–º–∞–∫—Å–∏–º—É–º 15)
  int index;         // –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –≤ –±—É—Ñ–µ—Ä–µ
  int size;          // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
  bool initialized;  // –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
} MedianFilter_t;

/* –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò–ó–ú–ï–†–ï–ù–ò–ô
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
 */
typedef struct {
  float rawValues[500];           // –°—ã—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (–º–∞–∫—Å–∏–º—É–º 500)
  float filteredValues[500];      // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
  float deltaValues[500];         // –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  unsigned long timestamps[500];  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ (–º—Å –æ—Ç –Ω–∞—á–∞–ª–∞)
  int count;                      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π
  int maxCount;                   // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π
} MeasurementData_t;

/* –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç–µ—Å—Ç–∞
 */
typedef struct {
  // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
  float minRaw;       // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å—ã—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  float maxRaw;       // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å—ã—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  float minFiltered;  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  float maxFiltered;  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

  // –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  float sumRaw;       // –°—É–º–º–∞ —Å—ã—Ä—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  float sumFiltered;  // –°—É–º–º–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

  // –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —à—É–º–∞ (–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥—Ä–µ–π—Ñ–∞)
  float noiseMin;    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —à—É–º–∞
  float noiseMax;    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —à—É–º–∞
  float noiseSum;    // –°—É–º–º–∞ –∑–Ω–∞—á–µ–Ω–∏–π —à—É–º–∞
  float noiseSumSq;  // –°—É–º–º–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π —à—É–º–∞

  // –í—Ä–µ–º—è —Ç–µ—Å—Ç–∞
  unsigned long startTime;  // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞ (–º—Å)
  unsigned long endTime;    // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ (–º—Å)
} Statistics_t;

// –≠–∫–∑–µ–º–ø–ª—è—Ä—ã —Å—Ç—Ä—É–∫—Ç—É—Ä
MedianFilter_t medianFilter;
MeasurementData_t measurements;
Statistics_t stats;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
bool testRunning = false;           // –§–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
int testPhase = 0;                  // –¢–µ–∫—É—â–∞—è —Ñ–∞–∑–∞ —Ç–µ—Å—Ç–∞ (0=—à—É–º, 1=—Ä–µ–∞–∫—Ü–∏—è)
unsigned long lastMeasureTime = 0;  // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è

// ============================================================================
// –†–ê–ó–î–ï–õ 5: –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò
// ============================================================================

/** * –§–£–ù–ö–¶–ò–Ø: roundToPrecision()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –ó–Ω–∞—á–µ–Ω–∏–µ, –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–µ –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–Ω–∞–∫–æ–≤
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   value - –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
 *   decimals - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
 * 
 * –ü—Ä–∏–º–µ—Ä—ã:
 *   roundToPrecision(23.4567, 2) ‚Üí 23.46
 *   roundToPrecision(23.4567, 1) ‚Üí 23.5
 *   roundToPrecision(23.4567, 0) ‚Üí 23
 */
float roundToPrecision(float value, int decimals) {
  // –í—ã—á–∏—Å–ª—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å: 10^decimals
  float multiplier = 1.0;
  for (int i = 0; i < decimals; i++) {
    multiplier *= 10.0;
  }

  // –û–∫—Ä—É–≥–ª—è–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
  float rounded = round(value * multiplier) / multiplier;

  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤—ã–≤–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
  // Serial.printf("–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ: %.6f * %.0f = %.6f ‚Üí %.6f\n",
  //               value, multiplier, value * multiplier, rounded);

  return rounded;
}

/** * –§–£–ù–ö–¶–ò–Ø: getConversionDelay()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –í—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   resolution - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞ (9-12 –±–∏—Ç)
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * DS18B20 —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
 * –≤ —Ü–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –≠—Ç–æ –≤—Ä–µ–º—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.
 * –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Å –∑–∞–ø–∞—Å–æ–º 25%.
 */
int getConversionDelay(uint8_t resolution) {
  // –ë–∞–∑–æ–≤—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏–∑ –¥–∞—Ç–∞—à–∏—Ç–∞ DS18B20
  int baseDelay;
  switch (resolution) {
    case 9: baseDelay = 94; break;    // 93.75 –º—Å –ø–æ –¥–∞—Ç–∞—à–∏—Ç—É
    case 10: baseDelay = 188; break;  // 187.5 –º—Å
    case 11: baseDelay = 375; break;  // 375 –º—Å
    case 12: baseDelay = 750; break;  // 750 –º—Å
    default: baseDelay = 750; break;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–∞–∫—Å–∏–º—É–º
  }

  // –î–æ–±–∞–≤–ª—è–µ–º 25% –∑–∞–ø–∞—Å–∞ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
  return baseDelay * 125 / 100;
}

/** * –§–£–ù–ö–¶–ò–Ø: formatNumberWithSign()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —á–∏—Å–ª–∞ —Å–æ –∑–Ω–∞–∫–æ–º –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   value - —á–∏—Å–ª–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 *   decimals - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
 *   width - –æ–±—â–∞—è —à–∏—Ä–∏–Ω–∞ –ø–æ–ª—è (–≤–∫–ª—é—á–∞—è –∑–Ω–∞–∫ –∏ —Ç–æ—á–∫—É)
 * 
 * –ü—Ä–∏–º–µ—Ä—ã:
 *   formatNumberWithSign(23.456, 2, 8) ‚Üí " +23.46"
 *   formatNumberWithSign(-23.456, 2, 8) ‚Üí " -23.46"
 *   formatNumberWithSign(0.0, 2, 8) ‚Üí "  +0.00"
 */
String formatNumberWithSign(float value, int decimals, int width) {
  String result;

  // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞–∫ (–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –¥–ª—è +0.00)
  if (value >= 0) {
    result = "+";
  } else {
    result = "-";
    value = -value;  // –†–∞–±–æ—Ç–∞–µ–º —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
  }

  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–Ω–∞–∫–æ–≤
  float rounded = roundToPrecision(value, decimals);

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
  result += String(rounded, decimals);

  // –î–æ–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–æ –Ω—É–∂–Ω–æ–π —à–∏—Ä–∏–Ω—ã
  while (result.length() < width) {
    result = " " + result;
  }

  return result;
}

// ============================================================================
// –†–ê–ó–î–ï–õ 6: –§–£–ù–ö–¶–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò
// ============================================================================

/** * –§–£–ù–ö–¶–ò–Ø: initMedianFilter()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –≤–µ—Å—å –±—É—Ñ–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
 * –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞ –¥–æ —Ç–æ–≥–æ,
 * –∫–∞–∫ –±—É—Ñ–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 */
void initMedianFilter(float initialValue) {
  medianFilter.size = FILTER_SIZE;
  medianFilter.index = 0;
  medianFilter.initialized = true;

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤–µ—Å—å –±—É—Ñ–µ—Ä –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
  for (int i = 0; i < medianFilter.size; i++) {
    medianFilter.buffer[i] = initialValue;
  }

  Serial.printf("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞: %d —Ç–æ—á–µ–∫, –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: %.2f¬∞C\n",
                medianFilter.size, initialValue);
}

/** * –§–£–ù–ö–¶–ò–Ø: applyMedianFilter()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–º–µ–¥–∏–∞–Ω–∞)
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   newValue - –Ω–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –º–µ–¥–∏–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞:
 * 1. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä
 * 2. –ö–æ–ø–∏—Ä—É–µ–º –±—É—Ñ–µ—Ä –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
 * 3. –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
 * 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (–º–µ–¥–∏–∞–Ω—É)
 */
float applyMedianFilter(float newValue) {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
  if (!medianFilter.initialized) {
    initMedianFilter(newValue);
    return newValue;
  }

  // 1. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
  medianFilter.buffer[medianFilter.index] = newValue;

  // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä)
  medianFilter.index = (medianFilter.index + 1) % medianFilter.size;

  // 3. –ö–æ–ø–∏—Ä—É–µ–º –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  float tempBuffer[15];  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
  for (int i = 0; i < medianFilter.size; i++) {
    tempBuffer[i] = medianFilter.buffer[i];
  }

  // 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—É–∑—ã—Ä—å–∫–æ–º (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
  for (int i = 0; i < medianFilter.size - 1; i++) {
    for (int j = 0; j < medianFilter.size - i - 1; j++) {
      if (tempBuffer[j] > tempBuffer[j + 1]) {
        // –û–±–º–µ–Ω –∑–Ω–∞—á–µ–Ω–∏–π
        float temp = tempBuffer[j];
        tempBuffer[j] = tempBuffer[j + 1];
        tempBuffer[j + 1] = temp;
      }
    }
  }

  // 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–¥–∏–∞–Ω—É (—Å—Ä–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç)
  float median = tempBuffer[medianFilter.size / 2];

  // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  // Serial.printf("–ú–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: –≤—Ö–æ–¥=%.3f, –≤—ã—Ö–æ–¥=%.3f, –±—É—Ñ–µ—Ä=[", newValue, median);
  // for (int i = 0; i < medianFilter.size; i++) {
  //     Serial.printf("%.3f", medianFilter.buffer[i]);
  //     if (i < medianFilter.size - 1) Serial.print(", ");
  // }
  // Serial.println("]");

  return median;
}

/** * –§–£–ù–ö–¶–ò–Ø: applyMovingAverage()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   newValue - –Ω–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—É–º–º—É –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∑–Ω–∞—á–µ–Ω–∏–π.
 * –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è:
 * 1. –í—ã—á–∏—Ç–∞–µ–º –∏–∑ —Å—É–º–º—ã —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
 * 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫ —Å—É–º–º–µ
 * 4. –î–µ–ª–∏–º —Å—É–º–º—É –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
 */
float applyMovingAverage(float newValue) {
  static float buffer[15];  // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä
  static int index = 0;     // –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
  static float sum = 0;     // –¢–µ–∫—É—â–∞—è —Å—É–º–º–∞
  static bool initialized = false;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
  if (!initialized) {
    for (int i = 0; i < FILTER_SIZE; i++) {
      buffer[i] = newValue;
    }
    sum = newValue * FILTER_SIZE;
    initialized = true;

    Serial.printf("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ: %d —Ç–æ—á–µ–∫, –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: %.2f¬∞C\n",
                  FILTER_SIZE, newValue);
    return newValue;
  }

  // 1. –í—ã—á–∏—Ç–∞–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å—É–º–º—ã
  sum -= buffer[index];

  // 2. –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤–æ–µ
  buffer[index] = newValue;

  // 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫ —Å—É–º–º–µ
  sum += newValue;

  // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä)
  index = (index + 1) % FILTER_SIZE;

  // 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ
  float average = sum / FILTER_SIZE;

  // –û—Ç–ª–∞–¥–∫–∞
  // Serial.printf("–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ: –≤—Ö–æ–¥=%.3f, –≤—ã—Ö–æ–¥=%.3f\n", newValue, average);

  return average;
}

/** * –§–£–ù–ö–¶–ò–Ø: applyExponentialSmoothing()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   newValue - –Ω–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * y[n] = Œ± * x[n] + (1 - Œ±) * y[n-1]
 * –≥–¥–µ:
 *   y[n] - —Ç–µ–∫—É—â–µ–µ —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 *   x[n] - —Ç–µ–∫—É—â–µ–µ –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 *   y[n-1] - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 *   Œ± - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (0 < Œ± < 1)
 */
float applyExponentialSmoothing(float newValue) {
  static float lastValue = 0;
  static bool initialized = false;

  if (!initialized) {
    lastValue = newValue;
    initialized = true;

    Serial.printf("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø. —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è: –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: %.2f¬∞C\n", newValue);
    return newValue;
  }

  // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
  float alpha = 0.3;

  // –§–æ—Ä–º—É–ª–∞ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
  float smoothed = alpha * newValue + (1 - alpha) * lastValue;
  lastValue = smoothed;

  // –û—Ç–ª–∞–¥–∫–∞
  // Serial.printf("–≠–∫—Å–ø. —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ: –≤—Ö–æ–¥=%.3f, –≤—ã—Ö–æ–¥=%.3f\n", newValue, smoothed);

  return smoothed;
}

/** * –§–£–ù–ö–¶–ò–Ø: applyTwoStageFilter()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   newValue - –Ω–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * 1. –ü–µ—Ä–≤–∞—è —Å—Ç—É–ø–µ–Ω—å: –º–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤)
 * 2. –í—Ç–æ—Ä–∞—è —Å—Ç—É–ø–µ–Ω—å: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —à—É–º–∞)
 */
float applyTwoStageFilter(float newValue) {
  // 1. –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤ –º–µ–¥–∏–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º
  float medianFiltered = applyMedianFilter(newValue);

  // 2. –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —à—É–º–∞ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º
  static float stage2Value = 0;
  static bool stage2Initialized = false;

  if (!stage2Initialized) {
    stage2Value = medianFiltered;
    stage2Initialized = true;
    return medianFiltered;
  }

  // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –≤—Ç–æ—Ä–æ–π —Å—Ç—É–ø–µ–Ω–∏
  float stage2Alpha = 0.4;
  stage2Value = stage2Alpha * medianFiltered + (1 - stage2Alpha) * stage2Value;

  // –û—Ç–ª–∞–¥–∫–∞
  // Serial.printf("–î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π: –≤—Ö–æ–¥=%.3f, –º–µ–¥–∏–∞–Ω–∞=%.3f, –≤—ã—Ö–æ–¥=%.3f\n",
  //               newValue, medianFiltered, stage2Value);

  return stage2Value;
}

/** * –§–£–ù–ö–¶–ò–Ø: applyFilter()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   rawValue - —Å—ã—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –¥–∞—Ç—á–∏–∫–∞
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
 * –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è FILTER_TYPE
 */
float applyFilter(float rawValue) {
  float filteredValue;

  switch (FILTER_TYPE) {
    case 0:  // –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
      filteredValue = rawValue;
      break;

    case 1:  // –ú–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
      filteredValue = applyMedianFilter(rawValue);
      break;

    case 2:  // –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
      filteredValue = applyMovingAverage(rawValue);
      break;

    case 3:  // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
      filteredValue = applyExponentialSmoothing(rawValue);
      break;

    case 4:  // –î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π —Ñ–∏–ª—å—Ç—Ä
      filteredValue = applyTwoStageFilter(rawValue);
      break;

    default:  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
      filteredValue = rawValue;
      break;
  }

  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
  filteredValue = roundToPrecision(filteredValue, ROUND_TO_DECIMALS);

  return filteredValue;
}

// ============================================================================
// –†–ê–ó–î–ï–õ 7: –§–£–ù–ö–¶–ò–ò –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê
// ============================================================================

/** * –§–£–ù–ö–¶–ò–Ø: initStatistics()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ—Å—Ç–∞.
 */
void initStatistics() {
  stats.minRaw = 1000.0;
  stats.maxRaw = -1000.0;
  stats.minFiltered = 1000.0;
  stats.maxFiltered = -1000.0;

  stats.sumRaw = 0.0;
  stats.sumFiltered = 0.0;

  stats.noiseMin = 1000.0;
  stats.noiseMax = -1000.0;
  stats.noiseSum = 0.0;
  stats.noiseSumSq = 0.0;

  stats.endTime = 0;

  Serial.println("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
}

/** * –§–£–ù–ö–¶–ò–Ø: updateStatistics()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–æ–≤—ã–º –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   rawValue - —Å—ã—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –¥–∞—Ç—á–∏–∫–∞
 *   filteredValue - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:
 * - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * - –°—É–º–º—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ
 * - –°—É–º–º—É –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–∏—Å–ø–µ—Ä—Å–∏–∏
 */
void updateStatistics(float rawValue, float filteredValue) {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  if (rawValue < stats.minRaw) stats.minRaw = rawValue;
  if (rawValue > stats.maxRaw) stats.maxRaw = rawValue;
  if (filteredValue < stats.minFiltered) stats.minFiltered = filteredValue;
  if (filteredValue > stats.maxFiltered) stats.maxFiltered = filteredValue;

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É–º–º
  stats.sumRaw += rawValue;
  stats.sumFiltered += filteredValue;
}

/** * –§–£–ù–ö–¶–ò–Ø: detectDeltaChange()
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –í–µ–ª–∏—á–∏–Ω–∞ –∑–Ω–∞—á–∏–º–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ 0
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   currentValue - —Ç–µ–∫—É—â–µ–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º.
 * –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥ DELTA_THRESHOLD,
 * –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ–ª–∏—á–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å —É—á—ë—Ç–æ–º –∑–Ω–∞–∫–∞).
 */
float detectDeltaChange(float currentValue) {
  static float previousValue = 0;
  static bool hasPrevious = false;

  // –ü–µ—Ä–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ - –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
  if (!hasPrevious) {
    previousValue = currentValue;
    hasPrevious = true;
    return 0.0;
  }

  // –í—ã—á–∏—Å–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  float delta = currentValue - previousValue;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
  previousValue = currentValue;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥ (–ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é)
  if (fabs(delta) >= DELTA_THRESHOLD) {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    return roundToPrecision(delta, ROUND_TO_DECIMALS);
  }

  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ–Ω—å—à–µ –ø–æ—Ä–æ–≥–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  return 0.0;
}

/** * –§–£–ù–ö–¶–ò–Ø: calculateNoiseStatistics()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —à—É–º–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * 1. –í—ã—á–∏—Å–ª—è–µ—Ç –ª–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥ –º–µ—Ç–æ–¥–æ–º –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤
 * 2. –í—ã—á–∏—Ç–∞–µ—Ç —Ç—Ä–µ–Ω–¥ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
 * 3. –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—Å—Ç–∞—Ç–∫–∞ (—à—É–º–∞)
 * 
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: true –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å, false –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
 */
bool calculateNoiseStatistics() {
  // –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10 —Ç–æ—á–µ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  if (measurements.count < 10) {
    Serial.println("‚ö†Ô∏è  –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —à—É–º–∞ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10 —Ç–æ—á–µ–∫)");
    return false;
  }

  int N = measurements.count;

  // 1. –í–´–ß–ò–°–õ–ï–ù–ò–ï –õ–ò–ù–ï–ô–ù–û–ì–û –¢–†–ï–ù–î–ê
  // –§–æ—Ä–º—É–ª—ã –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏: y = a + b*x
  float sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

  // –°—É–º–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
  for (int i = 0; i < N; i++) {
    float y = measurements.filteredValues[i];

    sumX += i;       // Œ£x
    sumY += y;       // Œ£y
    sumXY += i * y;  // Œ£xy
    sumX2 += i * i;  // Œ£x¬≤
  }

  // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
  float b = (N * sumXY - sumX * sumY) / (N * sumX2 - sumX * sumX);
  float a = (sumY - b * sumX) / N;

  // 2. –ê–ù–ê–õ–ò–ó –û–°–¢–ê–¢–ö–û–í (–®–£–ú–ê)
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —à—É–º–∞
  stats.noiseMin = 1000.0;
  stats.noiseMax = -1000.0;
  stats.noiseSum = 0.0;
  stats.noiseSumSq = 0.0;

  // –í—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –¥–∞–Ω–Ω—ã–º–∏ –∏ —Ç—Ä–µ–Ω–¥–æ–º)
  for (int i = 0; i < N; i++) {
    float y = measurements.filteredValues[i];
    float yTrend = a + b * i;     // –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –ª–∏–Ω–∏–∏ —Ç—Ä–µ–Ω–¥–∞
    float residual = y - yTrend;  // –û—Å—Ç–∞—Ç–æ–∫ (—à—É–º)

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —à—É–º–∞
    stats.noiseSum += residual;
    stats.noiseSumSq += residual * residual;

    if (residual < stats.noiseMin) stats.noiseMin = residual;
    if (residual > stats.noiseMax) stats.noiseMax = residual;
  }

  // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∏ –¥–∏—Å–ø–µ—Ä—Å–∏—é —à—É–º–∞
  float noiseMean = stats.noiseSum / N;
  float noiseVariance = (stats.noiseSumSq / N) - (noiseMean * noiseMean);

  // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  // Serial.printf("–¢—Ä–µ–Ω–¥: y = %.4f + %.4f*x (%.4f¬∞C/100–∏–∑–º)\n", a, b, b*100);
  // Serial.printf("–®—É–º: –º–∏–Ω=%.4f, –º–∞–∫—Å=%.4f, —Å—Ä–µ–¥–Ω–µ–µ=%.4f, –¥–∏—Å–ø–µ—Ä—Å–∏—è=%.6f\n",
  //               stats.noiseMin, stats.noiseMax, noiseMean, noiseVariance);

  return true;
}

/** * –§–£–ù–ö–¶–ò–Ø: calculateAutocorrelation()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ —à—É–º–∞
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª–∞–≥–æ–≤ (–∑–∞–¥–µ—Ä–∂–µ–∫).
 * –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —à—É–º "–±–µ–ª—ã–º" (—Å–ª—É—á–∞–π–Ω—ã–º)
 * –∏–ª–∏ –∏–º–µ–µ—Ç –∫–∞–∫—É—é-—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
 * 
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   lags - –º–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
 *   maxLags - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–≥–æ–≤ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
 * 
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
 */
int calculateAutocorrelation(float* lags, int maxLags) {
  // –ù—É–∂–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  if (measurements.count < 20) {
    Serial.println("‚ö†Ô∏è  –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 20 —Ç–æ—á–µ–∫)");
    return 0;
  }

  int N = measurements.count;

  // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  float mean = stats.sumFiltered / N;

  // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏—Å–ø–µ—Ä—Å–∏—é
  float variance = 0;
  for (int i = 0; i < N; i++) {
    float diff = measurements.filteredValues[i] - mean;
    variance += diff * diff;
  }
  variance /= N;

  // –ï—Å–ª–∏ –¥–∏—Å–ø–µ—Ä—Å–∏—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞
  if (variance < 0.000001) {
    Serial.println("‚ö†Ô∏è  –î–∏—Å–ø–µ—Ä—Å–∏—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏");
    return 0;
  }

  // –í—ã—á–∏—Å–ª—è–µ–º –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∞–≥–∞
  int calculatedLags = min(maxLags, N / 4);  // –ù–µ –±–æ–ª—å—à–µ —á–µ—Ç–≤–µ—Ä—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

  for (int lag = 0; lag < calculatedLags; lag++) {
    float correlation = 0;

    // –°—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º –ª–∞–≥–∞
    for (int i = 0; i < N - lag; i++) {
      float diff1 = measurements.filteredValues[i] - mean;
      float diff2 = measurements.filteredValues[i + lag] - mean;
      correlation += diff1 * diff2;
    }

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º
    lags[lag] = correlation / ((N - lag) * variance);
  }

  return calculatedLags;
}

// ============================================================================
// –†–ê–ó–î–ï–õ 8: –§–£–ù–ö–¶–ò–ò –í–´–í–û–î–ê –ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø
// ============================================================================

/** * –§–£–ù–ö–¶–ò–Ø: printProgressBar()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –í—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ [=====>     ] XX%
 * –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∑–Ω–∞—á–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–∫–∞–∂–¥—ã–µ 10% –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
 */
void printProgressBar(int current, int total) {
  static int lastPrintedPercent = -1;

  // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç
  int percent = (current * 100) / total;

  // –í—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
  // 1. –ü–µ—Ä–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ (current == 1)
  // 2. –ò–∑–º–µ–Ω–∏–ª—Å—è –¥–µ—Å—è—Ç–æ–∫ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (percent % 10 == 0)
  // 3. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ (current == total)
  if (current == 1 || percent != lastPrintedPercent || current == total) {
    lastPrintedPercent = percent;

    // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏
    int filledWidth = (percent * PROGRESS_BAR_WIDTH) / 100;
    int emptyWidth = PROGRESS_BAR_WIDTH - filledWidth;

    // –°—Ç—Ä–æ–∏–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    String progressBar = "[";
    for (int i = 0; i < filledWidth; i++) {
      progressBar += "=";
    }
    if (filledWidth < PROGRESS_BAR_WIDTH) {
      progressBar += ">";
      for (int i = 0; i < emptyWidth - 1; i++) {
        progressBar += " ";
      }
    }
    progressBar += "]";

    // –í—ã–≤–æ–¥–∏–º —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
    Serial.printf("%s %3d/%d (%3d%%)\n",
                  progressBar.c_str(), current, total, percent);
  }
}

/** * –§–£–ù–ö–¶–ò–Ø: printTestHeader()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–≤–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–µ—Å—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ—Å—Ç–∞ –¥–ª—è
 * —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å–ª–æ–≤–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞.
 */
void printTestHeader() {
  Serial.println("\n" + String(60, '='));
  Serial.println("–¢–ï–°–¢ –®–£–ú–ê DS18B20 - –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–ê–Ø –í–ï–†–°–ò–Ø");
  Serial.println(String(60, '='));

  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  Serial.println("–ù–ê–°–¢–†–û–ô–ö–ò –¢–ï–°–¢–ê:");
  Serial.printf("RESOLUTION: %d\n", RESOLUTION);
  Serial.printf("MEASURE_INTERVAL: %d\n", MEASURE_INTERVAL);

  const char* filterNames[] = {
    "–ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞", "–ú–µ–¥–∏–∞–Ω–Ω—ã–π", "–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ",
    "–≠–∫—Å–ø. —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ", "–î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π"
  };

  Serial.printf("FILTER_TYPE: %d (%s)\n", FILTER_TYPE, filterNames[FILTER_TYPE]);
  Serial.printf("FILTER_SIZE: %d\n", FILTER_SIZE);
  Serial.printf("DELTA_THRESHOLD: %.2f\n", DELTA_THRESHOLD);
  Serial.printf("ROUND_TO_DECIMALS: %d\n", ROUND_TO_DECIMALS);

  const char* modeNames[] = {
    "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π", "–¢–æ–ª—å–∫–æ —à—É–º", "–¢–æ–ª—å–∫–æ —Ä–µ–∞–∫—Ü–∏—è"
  };

  Serial.printf("TEST_MODE: %d (%s)\n", TEST_MODE, modeNames[TEST_MODE]);
  Serial.printf("TEST_DURATION: %d\n", TEST_DURATION);

  // –í—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
  int conversionTime = getConversionDelay(RESOLUTION);
  Serial.printf("–í—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏: %d –º—Å\n", conversionTime);

  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
  Serial.println("\n–ü–†–ò–ú–ï–ß–ê–ù–ò–Ø:");
  if (MEASURE_INTERVAL < conversionTime) {
    Serial.printf("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ò–Ω—Ç–µ—Ä–≤–∞–ª (%d –º—Å) –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (%d –º—Å)!\n",
                  MEASURE_INTERVAL, conversionTime);
  }

  // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
  if (TEST_MODE == 0) {
    Serial.println("\n–ò–ù–°–¢–†–£–ö–¶–ò–Ø:");
    Serial.println("1. –ü–µ—Ä–≤—ã–µ 50% –∏–∑–º–µ—Ä–µ–Ω–∏–π: –¥–∞—Ç—á–∏–∫ –≤ –ø–æ–∫–æ–µ (–∞–Ω–∞–ª–∏–∑ —à—É–º–∞)");
    Serial.println("2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50%: –ø–æ–¥–Ω–µ—Å–∏—Ç–µ –ø–∞–ª–µ—Ü –∫ –¥–∞—Ç—á–∏–∫—É (—Ç–µ—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏)");
  } else if (TEST_MODE == 1) {
    Serial.println("\n–ò–ù–°–¢–†–£–ö–¶–ò–Ø:");
    Serial.println("–î–∞—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –ø–æ–∫–æ–µ –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Ç–µ—Å—Ç–∞");
  } else if (TEST_MODE == 2) {
    Serial.println("\n–ò–ù–°–¢–†–£–ö–¶–ò–Ø:");
    Serial.println("–ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞ –ø–æ–¥–Ω–µ—Å–∏—Ç–µ –ø–∞–ª–µ—Ü –∫ –¥–∞—Ç—á–∏–∫—É");
  }

  Serial.println(String(60, '='));
  Serial.println();
}

/** * –§–£–ù–ö–¶–ò–Ø: printHistogram()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–≤–æ–¥ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —à—É–º–∞
 * 
 * –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø: –æ—Ç -0.09 –¥–æ +0.09 —Å —à–∞–≥–æ–º 0.01
 * –í—Å–µ–≥–æ 19 —Å—Ç—Ä–æ–∫: -0.09, -0.08, ..., +0.08, +0.09
 */
void printHistogram() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
  if (measurements.count < 10) {
    Serial.println("‚ö†Ô∏è  –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã");
    return;
  }

  // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —à—É–º–∞
  if (!calculateNoiseStatistics()) {
    return;
  }

  // –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø –¥–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
  const int NUM_VALUES = 19;  // -0.09 –¥–æ +0.09 —Å —à–∞–≥–æ–º 0.01
  float values[NUM_VALUES];
  int counts[NUM_VALUES] = { 0 };

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
  for (int i = 0; i < NUM_VALUES; i++) {
    values[i] = -0.09 + (i * 0.01);
  }

  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
  for (int i = 0; i < measurements.count; i++) {
    // –®—É–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–µ–¥–∏–∞–Ω—ã
    float median = stats.sumFiltered / measurements.count;
    float noise = measurements.filteredValues[i] - median;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ –∫–∞–∫–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–ø–∞–¥–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ
    // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã: [-0.095, -0.085), [-0.085, -0.075), ...
    int binIndex = -1;

    // –û—Å–æ–±—ã–π —Å–ª—É—á–∞–π –¥–ª—è -0.09 (–ø–µ—Ä–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
    if (noise < -0.085) {
      binIndex = 0;  // -0.09
    }
    // –û—Å–æ–±—ã–π —Å–ª—É—á–∞–π –¥–ª—è +0.09 (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
    else if (noise >= 0.085) {
      binIndex = NUM_VALUES - 1;  // +0.09
    }
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
    else {
      // –°–º–µ—â–∞–µ–º –Ω–∞ 0.005 —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
      binIndex = (int)((noise + 0.095) / 0.01);
      if (binIndex < 0) binIndex = 0;
      if (binIndex >= NUM_VALUES) binIndex = NUM_VALUES - 1;
    }

    counts[binIndex]++;
  }

  // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  int maxCount = 0;
  for (int i = 0; i < NUM_VALUES; i++) {
    if (counts[i] > maxCount) maxCount = counts[i];
  }

  if (maxCount == 0) {
    Serial.println("‚ö†Ô∏è  –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã");
    return;
  }

  // –í—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  Serial.println("\n–ì–ò–°–¢–û–ì–†–ê–ú–ú–ê –®–£–ú–ê (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–µ–¥–∏–∞–Ω—ã):");

  // –í—ã–≤–æ–¥–∏–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É
  for (int i = 0; i < NUM_VALUES; i++) {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    String valueStr;
    if (values[i] >= 0) {
      valueStr = "+" + String(values[i], 2);
    } else {
      valueStr = String(values[i], 2);
    }

    // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–æ 6 —Å–∏–º–≤–æ–ª–æ–≤
    while (valueStr.length() < 6) {
      valueStr = " " + valueStr;
    }

    // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞
    int barWidth = 0;
    if (maxCount > 0) {
      barWidth = (counts[i] * HISTOGRAM_WIDTH) / maxCount;
    }

    // –°—Ç—Ä–æ–∏–º —Å—Ç–æ–ª–±–µ—Ü
    String bar;
    for (int j = 0; j < barWidth; j++) {
      bar += "‚ñà";
    }

    // –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É
    Serial.printf("%s %s\n", valueStr.c_str(), bar.c_str());
  }

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–æ–π
  Serial.printf("   –ò–∑–º–µ—Ä–µ–Ω–∏–π: %d, –ú–∞–∫—Å –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ: %d\n", measurements.count, maxCount);
  Serial.printf("   –î–∏–∞–ø–∞–∑–æ–Ω —à—É–º–∞: –æ—Ç %.3f –¥–æ %.3f¬∞C\n", stats.noiseMin, stats.noiseMax);
  Serial.printf("   –°–ö–û (œÉ): %.4f¬∞C\n",
                sqrt((stats.noiseSumSq / measurements.count) - pow(stats.noiseSum / measurements.count, 2)));
}

/** * –§–£–ù–ö–¶–ò–Ø: printAutocorrelation()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
 * 
 * –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
 * 1. –õ–∞–≥ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1 (–∞ –Ω–µ 0)
 * 2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: –ª–∞–≥ 1 = 1.5 —Å–µ–∫, –ª–∞–≥ 2 = 3.0 —Å–µ–∫ –∏ —Ç.–¥.
 * 3. –£–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π (–ª–∞–≥ 0 = 1.00)
 */
void printAutocorrelation() {
  // –í—ã—á–∏—Å–ª—è–µ–º –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é
  float lags[AUTOCORR_LAGS];
  int numLags = calculateAutocorrelation(lags, AUTOCORR_LAGS);

  if (numLags == 0) {
    return;
  }

  Serial.println("\n–ê–í–¢–û–ö–û–†–†–ï–õ–Ø–¶–ò–Ø (–±–µ–ª—ã–π —à—É–º = 0):");

  // –í—ã–≤–æ–¥–∏–º –∫–∞–∂–¥—ã–π –ª–∞–≥ (–Ω–∞—á–∏–Ω–∞—è —Å 1, –∞ –Ω–µ 0)
  for (int lagIndex = 1; lagIndex <= numLags; lagIndex++) {
    float correlation = lags[lagIndex - 1];  // –í –º–∞—Å—Å–∏–≤–µ –∏–Ω–¥–µ–∫—Å lagIndex-1
    float timeSeconds = (lagIndex * MEASURE_INTERVAL) / 1000.0;

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –ª–∞–≥–æ–º
    String lagStr = "–õ–∞–≥ " + String(lagIndex) + " (" + String(timeSeconds, 1) + " —Å–µ–∫):";
    while (lagStr.length() < 22) {
      lagStr += " ";
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
    String corrStr;
    if (correlation >= 0) {
      corrStr = " +" + String(correlation, 2);
    } else {
      corrStr = " " + String(correlation, 2);
    }
    while (corrStr.length() < 7) {
      corrStr += " ";
    }

    // –°—Ç—Ä–æ–∏–º –ø—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
    String graph = "[";
    int graphWidth = 20;
    int fillWidth = (int)(fabs(correlation) * graphWidth);

    if (correlation >= 0) {
      for (int i = 0; i < fillWidth; i++) {
        graph += "=";
      }
      for (int i = fillWidth; i < graphWidth; i++) {
        graph += " ";
      }
    } else {
      for (int i = 0; i < graphWidth - fillWidth; i++) {
        graph += " ";
      }
      for (int i = 0; i < fillWidth; i++) {
        graph += "=";
      }
    }
    graph += "]";

    // –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É
    Serial.printf("%s %s %s\n", lagStr.c_str(), corrStr.c_str(), graph.c_str());
  }

  // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  Serial.println("\n–ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø:");

  bool hasSignificantCorrelation = false;
  for (int lagIndex = 0; lagIndex < numLags; lagIndex++) {
    if (fabs(lags[lagIndex]) > 0.3) {
      hasSignificantCorrelation = true;
      break;
    }
  }

  if (hasSignificantCorrelation) {
    Serial.println("‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–Ω–∞—á–∏–º–∞—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è");
    Serial.println("   –®—É–º –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –±–µ–ª—ã–º (—Å–ª—É—á–∞–π–Ω—ã–º)");
    Serial.println("   –í–æ–∑–º–æ–∂–Ω—ã —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è");

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    if (lags[0] > 0.8) {  // –ü–µ—Ä–≤—ã–π –ª–∞–≥ (1.5 —Å–µ–∫)
      Serial.println("   üí° –°–æ–≤–µ—Ç: –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä");
    }
  } else {
    Serial.println("‚úÖ –®—É–º –±–ª–∏–∑–æ–∫ –∫ –±–µ–ª–æ–º—É (—Å–ª—É—á–∞–π–Ω–æ–º—É)");
    Serial.println("   –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ");
  }

  // –í—ã–≤–æ–¥–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  Serial.println("\n–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ê–í–¢–û–ö–û–†–†–ï–õ–Ø–¶–ò–ò:");
  if (numLags > 0) {
    float firstCorr = lags[0];
    if (firstCorr > 0.7) {
      Serial.printf("   –ê–≤—Ç–æ–∫–æ—Ä—Ä. –ª–∞–≥ 1: %.2f ‚Üí —Ñ–∏–ª—å—Ç—Ä —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω—ã–π\n", firstCorr);
      Serial.println("   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å FILTER_SIZE");
    } else if (firstCorr < -0.3) {
      Serial.printf("   –ê–≤—Ç–æ–∫–æ—Ä—Ä. –ª–∞–≥ 1: %.2f ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã –∫–æ–ª–µ–±–∞–Ω–∏—è\n", firstCorr);
      Serial.println("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–∏—Ç–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞");
    } else {
      Serial.printf("   –ê–≤—Ç–æ–∫–æ—Ä—Ä. –ª–∞–≥ 1: %.2f ‚Üí —Ö–æ—Ä–æ—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n", firstCorr);
    }
  }
}

/** * –§–£–ù–ö–¶–ò–Ø: printCSVData()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º —Å—Ç–æ–ª–±—Ü–æ–≤
 * 
 * –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
 * 1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –º–µ–∂–¥—É –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
 * 2. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
 * 3. –ß—ë—Ç–∫–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∫–æ–ª–æ–Ω–æ–∫
 */
void printCSVData() {
  Serial.println("\nCSV –î–ê–ù–ù–´–ï (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ Excel):");

  // –í—ã–≤–æ–¥–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
  Serial.println("# –ù–ê–°–¢–†–û–ô–ö–ò –¢–ï–°–¢–ê:");
  Serial.println("# RESOLUTION=" + String(RESOLUTION));
  Serial.println("# MEASURE_INTERVAL=" + String(MEASURE_INTERVAL));
  Serial.println("# FILTER_TYPE=" + String(FILTER_TYPE));
  Serial.println("# FILTER_SIZE=" + String(FILTER_SIZE));
  Serial.println("# DELTA_THRESHOLD=" + String(DELTA_THRESHOLD, 2));
  Serial.println("# ROUND_TO_DECIMALS=" + String(ROUND_TO_DECIMALS));
  Serial.println("# TEST_MODE=" + String(TEST_MODE));
  Serial.println("# TEST_DURATION=" + String(TEST_DURATION));
  Serial.println("#");

  // ===== –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö –° –ü–†–û–ë–ï–õ–ê–ú–ò =====
  String header = "–í–†–ï–ú–Ø_–ú–°";
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –¥–æ –Ω—É–∂–Ω–æ–π —à–∏—Ä–∏–Ω—ã
  while (header.length() < CSV_TIME_WIDTH) {
    header += " ";
  }

  header += "–¢–ï–ú–ü_–°–´–†–ê–Ø";
  while (header.length() < CSV_TIME_WIDTH + CSV_TEMP_WIDTH) {
    header += " ";
  }

  header += "–¢–ï–ú–ü_–§–ò–õ–¨–¢";
  while (header.length() < CSV_TIME_WIDTH + CSV_TEMP_WIDTH * 2) {
    header += " ";
  }

  header += "–î–ï–õ–¨–¢–ê";

  Serial.println(header);
  Serial.println(String(header.length(), '-'));  // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è

  // –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫ –∏–ª–∏ –≤—Å–µ, –µ—Å–ª–∏ –º–µ–Ω—å—à–µ)
  int rowsToShow = min(20, measurements.count);

  for (int i = 0; i < rowsToShow; i++) {
    String row;

    // 1. –í–†–ï–ú–Ø (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é)
    String timeStr = String(measurements.timestamps[i]);
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã —Å–ª–µ–≤–∞
    while (timeStr.length() < CSV_TIME_WIDTH) {
      timeStr = " " + timeStr;
    }
    row += timeStr;

    // 2. –°–´–†–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é)
    String rawTempStr = String(measurements.rawValues[i], 2);
    while (rawTempStr.length() < CSV_TEMP_WIDTH) {
      rawTempStr = " " + rawTempStr;
    }
    row += rawTempStr;

    // 3. –§–ò–õ–¨–¢–†–û–í–ê–ù–ù–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é)
    String filtTempStr = String(measurements.filteredValues[i], 2);
    while (filtTempStr.length() < CSV_TEMP_WIDTH) {
      filtTempStr = " " + filtTempStr;
    }
    row += filtTempStr;

    // 4. –î–ï–õ–¨–¢–ê (—Å–æ –∑–Ω–∞–∫–æ–º, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é)
    float delta = measurements.deltaValues[i];
    String deltaStr;
    if (delta >= 0) {
      deltaStr = "+" + String(delta, 2);
    } else {
      deltaStr = String(delta, 2);
    }
    // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–µ–ª—å—Ç—É
    while (deltaStr.length() < CSV_DELTA_WIDTH) {
      deltaStr = " " + deltaStr;
    }
    row += deltaStr;

    Serial.println(row);
  }

  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ 20 —Å—Ç—Ä–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ
  if (measurements.count > 20) {
    Serial.println(String(header.length(), '.'));  // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
    Serial.printf("# ... –∏ –µ—â—ë %d —Å—Ç—Ä–æ–∫\n", measurements.count - 20);
    Serial.println("# –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã");
  }

  // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ CSV –¥–∞–Ω–Ω—ã—Ö
  Serial.println();
}

/** * –§–£–ù–ö–¶–ò–Ø: printTestResults()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç
 * —Å –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–æ–π, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ CSV –¥–∞–Ω–Ω—ã–º–∏.
 */
void printTestResults() {
  Serial.println("\n" + String(60, '='));
  Serial.println("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê");
  Serial.println(String(60, '='));

  // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  Serial.println("\n–°–¢–ê–¢–ò–°–¢–ò–ö–ê:");

  float avgRaw = stats.sumRaw / measurements.count;
  float avgFiltered = stats.sumFiltered / measurements.count;
  float totalRange = stats.maxRaw - stats.minRaw;

  Serial.printf("–û–±—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω:  %.2f¬∞C ‚îÄ‚îÄ %.2f¬∞C (Œî=%.2f¬∞C)\n",
                stats.minRaw, stats.maxRaw, totalRange);

  Serial.printf("–°—Ä–µ–¥–Ω–µ–µ (—Å—ã—Ä–æ–µ): %.2f¬∞C\n", avgRaw);
  Serial.printf("–°—Ä–µ–¥–Ω–µ–µ (—Ñ–∏–ª—å—Ç—Ä): %.2f¬∞C\n", avgFiltered);

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —à—É–º–∞
  if (calculateNoiseStatistics()) {
    float noiseRange = stats.noiseMax - stats.noiseMin;
    float noiseStdDev = sqrt((stats.noiseSumSq / measurements.count) - pow(stats.noiseSum / measurements.count, 2));

    Serial.printf("–ß–∏—Å—Ç—ã–π —à—É–º:      %.3f¬∞C —Ä–∞–∑–º–∞—Ö\n", noiseRange);
    Serial.printf("–°–ö–û (œÉ):         %.4f¬∞C\n", noiseStdDev);

    // –û—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –∫ —à—É–º—É
    if (noiseStdDev > 0) {
      float sigmaRatio = DELTA_THRESHOLD / noiseStdDev;
      Serial.printf("–û—Ç–Ω–æ—à–µ–Ω–∏–µ œÉ/–ø–æ—Ä–æ–≥: %.1fœÉ\n", sigmaRatio);

      if (sigmaRatio >= 3.0) {
        Serial.println("   ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –ø–æ–º–µ—Ö–∏ –Ω–µ –≤—ã–∑–æ–≤—É—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π");
      } else if (sigmaRatio >= 2.0) {
        Serial.println("   ‚ö†Ô∏è  –†–∏—Å–∫: –≤–æ–∑–º–æ–∂–Ω—ã —Å–ª—É—á–∞–π–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è");
      } else {
        Serial.println("   ‚ùå –û–ø–∞—Å–Ω–æ: –≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π");
      }
    }
  }

  // –í—Ä–µ–º—è —Ç–µ—Å—Ç–∞
  unsigned long testDuration = stats.endTime - stats.startTime;
  Serial.printf("–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞:     %.1f –º–∏–Ω—É—Ç\n", testDuration / 60000.0);
  Serial.printf("–ò–∑–º–µ—Ä–µ–Ω–∏–π:       %d/%d\n", measurements.count, TEST_DURATION);

  // –í—ã–≤–æ–¥–∏–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É
  printHistogram();

  // –í—ã–≤–æ–¥–∏–º –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é
  printAutocorrelation();

  // –í—ã–≤–æ–¥–∏–º CSV –¥–∞–Ω–Ω—ã–µ
  printCSVData();

  Serial.println("\n" + String(60, '='));
  Serial.println("–¢–ï–°–¢ –ó–ê–í–ï–†–®–Å–ù");
  Serial.println(String(60, '='));
}

// ============================================================================
// –†–ê–ó–î–ï–õ 9: –§–£–ù–ö–¶–ò–ò –¢–ï–°–¢–ê –†–ï–ê–ö–¶–ò–ò
// ============================================================================

/** * –§–£–ù–ö–¶–ò–Ø: runReactionTest()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ —Ä–µ–∞–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
 * 
 * –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
 * 1. –í—ã–≤–æ–¥–∏—Ç –æ—Ç—Å—á—ë—Ç 10...1
 * 2. –ü—Ä–æ—Å–∏—Ç –∫–æ—Å–Ω—É—Ç—å—Å—è –¥–∞—Ç—á–∏–∫–∞
 * 3. –ó–∞–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –æ—Ç —Å–∏–≥–Ω–∞–ª–∞ –¥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
 * 4. –ó–∞–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è
 * 
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: true –µ—Å–ª–∏ —Ç–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ, false –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
 */
bool runReactionTest() {
  Serial.println("\n" + String(50, '='));
  Serial.println("–¢–ï–°–¢ –†–ï–ê–ö–¶–ò–ò");
  Serial.println(String(50, '='));

  Serial.println("–ü–û–î–ì–û–¢–û–í–ö–ê...");
  delay(1000);

  // –û—Ç—Å—á—ë—Ç 10...1
  for (int i = 10; i > 0; i--) {
    Serial.printf("%d ", i);
    delay(1000);
  }

  Serial.println("\n–ö–ê–°–ê–ô–¢–ï–°–¨!");
  unsigned long touchSignalTime = millis();

  // –ñ–¥—ë–º –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
  bool changeDetected = false;
  unsigned long changeStartTime = 0;
  unsigned long detectionTime = 0;
  float detectedDelta = 0;

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π
  static float lastValueForReaction = 0;
  static bool hasLastValue = false;
  lastValueForReaction = 0;
  hasLastValue = false;

  // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
  unsigned long reactionTestEnd = millis() + 30000;

  while (millis() < reactionTestEnd && !changeDetected) {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∏–∑–º–µ—Ä–µ–Ω–∏–µ
    sensors.requestTemperatures();
    delay(getConversionDelay(RESOLUTION));

    float rawTemp = sensors.getTempC(sensorAddress);
    if (rawTemp == DEVICE_DISCONNECTED_C) {
      continue;
    }

    float filteredTemp = applyFilter(rawTemp);

    // –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    if (!hasLastValue) {
      lastValueForReaction = filteredTemp;
      hasLastValue = true;
    } else {
      float delta = filteredTemp - lastValueForReaction;
      lastValueForReaction = filteredTemp;

      if (fabs(delta) >= DELTA_THRESHOLD) {
        changeDetected = true;
        changeStartTime = millis();  // –í—Ä–µ–º—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        detectedDelta = delta;

        // –ù—É–∂–Ω–æ –µ—â—ë –æ–¥–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        delay(MEASURE_INTERVAL);

        sensors.requestTemperatures();
        delay(getConversionDelay(RESOLUTION));

        float confirmTemp = sensors.getTempC(sensorAddress);
        float confirmFiltered = applyFilter(confirmTemp);

        float confirmDelta = confirmFiltered - filteredTemp;
        if (fabs(confirmDelta) >= DELTA_THRESHOLD * 0.5) {
          detectionTime = millis();
        }
      }
    }

    delay(MEASURE_INTERVAL / 2);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—â–µ, —á–µ–º –æ–±—ã—á–Ω–æ
  }

  // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  if (changeDetected) {
    Serial.println("\n–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê –†–ï–ê–ö–¶–ò–ò:");
    Serial.println("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");

    if (touchSignalTime > 0 && changeStartTime > touchSignalTime) {
      float timeFromSignal = (changeStartTime - touchSignalTime) / 1000.0;
      Serial.printf("‚îÇ –í—Ä–µ–º—è –æ—Ç —Å–∏–≥–Ω–∞–ª–∞:     %5.1f —Å–µ–∫       ‚îÇ\n", timeFromSignal);
    }

    if (detectionTime > 0 && changeStartTime > 0) {
      float timeFromChange = (detectionTime - changeStartTime) / 1000.0;
      Serial.printf("‚îÇ –í—Ä–µ–º—è –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:  %5.1f —Å–µ–∫       ‚îÇ\n", timeFromChange);
    }

    Serial.printf("‚îÇ –ò–∑–º–µ–Ω–µ–Ω–∏–µ:           %+6.2f¬∞C         ‚îÇ\n", detectedDelta);
    Serial.println("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");

    return true;
  } else {
    Serial.println("\n‚ùå –ò–ó–ú–ï–ù–ï–ù–ò–ï –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù–û");
    Serial.println("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞");
    return false;
  }
}

// ============================================================================
// –†–ê–ó–î–ï–õ 10: –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ARDUINO
// ============================================================================

/** * –§–£–ù–ö–¶–ò–Ø: setup()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
 */
void setup() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
  Serial.begin(115200);
  delay(2000);  // –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏

  Serial.println("\n\n");
  Serial.println(String(50, '*'));
  Serial.println("*  –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–´–ô –¢–ï–°–¢–ï–† DS18B20  *");
  Serial.println("*        –í–µ—Ä—Å–∏—è 3.0               *");
  Serial.println(String(50, '*'));

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–∞
  Serial.println("\nüîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã...");
  sensors.begin();
  delay(100);

  // –ü–æ–∏—Å–∫ –¥–∞—Ç—á–∏–∫–∞
  Serial.print("üîç –ü–æ–∏—Å–∫ –¥–∞—Ç—á–∏–∫–æ–≤... ");
  int deviceCount = sensors.getDeviceCount();
  Serial.printf("–Ω–∞–π–¥–µ–Ω–æ: %d\n", deviceCount);

  if (deviceCount == 0) {
    Serial.println("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –î–∞—Ç—á–∏–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!");
    Serial.println("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ");
    while (true) {
      delay(1000);
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–∞—Ç—á–∏–∫–∞
  if (!sensors.getAddress(sensorAddress, 0)) {
    Serial.println("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –¥–∞—Ç—á–∏–∫–∞!");
    while (true) {
      delay(1000);
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
  sensors.setResolution(sensorAddress, RESOLUTION);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
  measurements.count = 0;
  measurements.maxCount = min(500, TEST_DURATION);

  initStatistics();

  // –í—ã–≤–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–µ—Å—Ç–∞
  printTestHeader();

  // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
  testRunning = true;
  testPhase = 0;

  Serial.println("‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é");
  Serial.println("   –ù–∞—á–∏–Ω–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...\n");
  Serial.println();
  delay(3000);

  stats.startTime = millis();  // –¢–µ–ø–µ—Ä—å –≤—Ä–µ–º—è –Ω–∞—á–Ω—ë—Ç—Å—è —Å 0
  Serial.println("üïê –¢–∞–π–º–µ—Ä —Ç–µ—Å—Ç–∞ –∑–∞–ø—É—â–µ–Ω (–≤—Ä–µ–º—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0 –º—Å)");
}

/** * –§–£–ù–ö–¶–ò–Ø: loop()
 * –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
 */
void loop() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–∏ –µ—â—ë —Ç–µ—Å—Ç
  if (!testRunning) {
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è
  unsigned long currentTime = millis();
  if (currentTime - lastMeasureTime < MEASURE_INTERVAL) {
    return;
  }

  lastMeasureTime = currentTime;

  // –í—ã–ø–æ–ª–Ω—è–µ–º –∏–∑–º–µ—Ä–µ–Ω–∏–µ
  sensors.requestTemperatures();
  delay(getConversionDelay(RESOLUTION));

  // –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  float rawTemperature = sensors.getTempC(sensorAddress);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è
  if (rawTemperature == DEVICE_DISCONNECTED_C) {
    Serial.printf("[%6lu –º—Å] ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞\n", currentTime - stats.startTime);
    return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  float filteredTemperature = applyFilter(rawTemperature);
  float deltaChange = detectDeltaChange(filteredTemperature);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  if (measurements.count < measurements.maxCount) {
    measurements.rawValues[measurements.count] = rawTemperature;
    measurements.filteredValues[measurements.count] = filteredTemperature;
    measurements.deltaValues[measurements.count] = deltaChange;
    measurements.timestamps[measurements.count] = currentTime - stats.startTime;
    measurements.count++;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    updateStatistics(rawTemperature, filteredTemperature);

    // –í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    printProgressBar(measurements.count, TEST_DURATION);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã —à—É–º–∞ (–¥–ª—è TEST_MODE 0)
  if (TEST_MODE == 0 && testPhase == 0 && measurements.count >= TEST_DURATION / 2) {
    testPhase = 1;
    Serial.println("\n\n" + String(50, '-'));
    Serial.println("–§–ê–ó–ê 1 –ó–ê–í–ï–†–®–ï–ù–ê: –ê–Ω–∞–ª–∏–∑ —à—É–º–∞");
    Serial.println("üëÜ –¢–µ–ø–µ—Ä—å –ø–æ–¥–Ω–µ—Å–∏—Ç–µ –ø–∞–ª–µ—Ü –∫ –¥–∞—Ç—á–∏–∫—É –¥–ª—è —Ç–µ—Å—Ç–∞ —Ä–µ–∞–∫—Ü–∏–∏");
    Serial.println(String(50, '-') + "\n");
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
  if (measurements.count >= TEST_DURATION) {
    testRunning = false;
    stats.endTime = millis();

    // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    Serial.println();

    // –ü–∞—É–∑–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞
    delay(1000);

    // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    printTestResults();

    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ —Ä–µ–∞–∫—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    if (TEST_MODE == 0 || TEST_MODE == 2) {
      runReactionTest();
    }

    Serial.println("\n" + String(50, '='));
    Serial.println("üõë –ü–†–û–ì–†–ê–ú–ú–ê –ó–ê–í–ï–†–®–ï–ù–ê");
    Serial.println(String(50, '='));
    Serial.println("–î–ª—è –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ");

    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    while (true) {
      delay(1000);
    }
  }
}